# Bangumi-月幕游戏匹配系统 v3.0

## 版本概述

**v3.0 异步爬虫版本** - 基于 `asyncio` 和 `aiohttp` 实现的高并发异步数据处理系统，显著提升大规模数据处理效率，支持智能批次管理和完整的日志记录功能。

## 功能特性

### 🔄 **异步处理引擎**
- **高并发处理**: 支持2-20个并发请求，处理速度提升3-8倍
- **智能批次管理**: 可配置批次大小（10-500），优化内存使用和API效率
- **自适应限流**: 动态调整请求间隔，避免503错误
- **断点续传**: 支持从上次中断的地方继续处理

### 📊 **数据处理功能**
- **多种匹配模式**: 同步/异步原始匹配、同步/异步别名匹配
- **智能匹配算法**: 精确匹配、模糊匹配、会社匹配
- **Excel文件支持**: 自动处理多种数据格式
- **会社信息获取**: 自动获取和匹配游戏会社详细信息

### 📝 **日志管理系统**
- **完整API日志**: 所有API请求和响应记录到logs目录
- **静默模式**: 控制台输出简洁，详细信息保存到日志文件
- **错误追踪**: 详细的错误处理和重试机制日志
- **性能统计**: 实时显示处理进度和成功率

### 🎯 **交互式操作**
- **文件选择**: 交互式选择data目录中的Excel文件
- **模式选择**: 支持5种匹配模式选择
- **批次配置**: 可自定义批次大小，优化性能
- **性能对比**: 内置同步vs异步性能测试

## 项目结构

```
Spider Project/
├── src/                    # 源代码目录
│   ├── api/               # API客户端
│   │   └── api_client.py  # 月幕API客户端
│   ├── async_spider/      # 异步爬虫模块
│   │   ├── async_spider_engine.py    # 异步爬虫引擎
│   │   ├── async_matching_engine.py  # 异步匹配引擎
│   │   └── buffer_manager.py         # 缓冲池管理器
│   ├── core/              # 核心控制器
│   │   └── main_controller.py
│   ├── data/              # 数据处理
│   │   └── data_processor.py
│   ├── matching/          # 匹配引擎
│   │   └── matching_engine.py
│   ├── organization/      # 会社管理
│   │   └── organization_manager.py
│   └── utils/             # 工具类
│       └── logger.py      # 日志管理
├── data/                  # 输入数据目录
├── save/                  # 输出结果目录
├── logs/                  # 日志文件目录
├── main.py               # 主程序入口
├── requirements.txt      # 依赖包列表
└── README.md            # 项目说明
```

## 快速开始

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 准备数据

将需要匹配的Excel文件放入`data/`目录。

### 3. 运行程序

```bash
python main.py
```

程序会提示你选择：
- 匹配模式（5种模式可选）
- 源文件（从data目录中选择）
- 批次大小（异步模式）

### 4. 查看结果

匹配结果会保存在`save/`目录中，日志文件保存在`logs/`目录。

## 匹配模式说明

### 1. 同步原始匹配
- 使用日文名和中文名进行匹配
- 适合小数据集，处理稳定
- 串行处理，速度较慢

### 2. 同步别名匹配
- 使用别名列进行匹配
- 支持多个别名同时搜索
- 适合有丰富别名数据的情况

### 3. 异步原始匹配（推荐）
- 高并发处理，速度提升3-8倍
- 支持自定义批次大小
- 适合大数据集处理

### 4. 异步别名匹配（推荐）
- 异步处理别名匹配
- 高并发，支持大批量数据
- 智能错误处理和重试

### 5. 性能对比测试
- 自动对比同步vs异步性能
- 显示速度提升倍数
- 提供性能优化建议

## 配置参数

### 异步引擎配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `max_concurrent` | 8 | 最大并发请求数 |
| `buffer_size` | 500 | 缓冲区大小（条记录） |
| `write_interval` | 1.0 | 写入间隔（秒） |
| `batch_size` | 50 | 批次大小（可配置） |

### 性能优化建议

- **小数据集** (< 100条): 批次大小 10-25，并发数 3-5
- **中等数据集** (100-1000条): 批次大小 50-100，并发数 5-8
- **大数据集** (> 1000条): 批次大小 100-200，并发数 8-12
- **503错误频繁**: 批次大小 25-50，并发数 2-3

## 日志功能

### 日志文件
- **位置**: `logs/`目录
- **格式**: `api_responses_YYYYMMDD_HHMMSS.log`
- **内容**: 完整的API请求、响应和错误信息

### 日志记录内容
- API搜索响应（游戏匹配结果）
- 会社信息发现记录
- 会社详情API响应
- 错误信息（Token失效、503错误等）
- 重要操作记录

## 与同步版本对比

| 特性 | 同步版本 | 异步版本 |
|------|----------|----------|
| 处理速度 | 基准 | 3-8倍提升 |
| 内存使用 | 较低 | 中等（缓冲池） |
| 并发能力 | 串行 | 高并发 |
| 批次管理 | 固定 | 可配置 |
| 错误处理 | 基础 | 增强 |
| 日志记录 | 完整 | 完整 |
| 适用场景 | 小数据集 | 大规模数据 |

## 故障排除

### 常见问题

1. **503错误（服务器过载）**
   - 降低并发数到2-3
   - 减小批次大小到25-50
   - 增加请求间隔

2. **内存不足**
   - 减小缓冲区大小
   - 降低并发数
   - 增加写入频率

3. **Token获取失败**
   - 检查网络连接
   - 验证API凭据

### 性能调优

- **网络良好**: 可提高并发数和批次大小
- **网络不稳定**: 降低并发数，增加重试次数
- **API限流**: 大幅降低并发数，增加请求间隔

## 更新日志

### v3.0.0 (当前版本)
- ✅ 异步爬虫引擎: 基于asyncio的高并发处理
- ✅ 智能批次管理: 可配置批次大小，优化性能
- ✅ 完整日志系统: 所有API请求记录到日志文件
- ✅ 交互式配置: 支持文件选择和批次大小配置
- ✅ 性能对比测试: 内置同步vs异步性能测试
- ✅ 错误处理增强: 智能重试和503错误处理
- ✅ 缓冲池管理: 异步数据缓冲和批量写入

### v2.0.0
- ✅ 重构为面向对象设计
- ✅ 添加多种匹配模式
- ✅ 实现交互式操作
- ✅ 完善日志系统

### v1.0.0
- ✅ 基础匹配功能
- ✅ API集成
- ✅ 数据导出

### v3.0
- 新增异步批量爬取功能，支持高并发与自适应拥塞控制算法，提升了处理效率。
- 尝试集成自动冷却与重试机制以应对服务器限流（503）问题。
- 由于目标服务器限流机制复杂，503 问题未能完全解决，部分请求仍可能频繁遇到 503。
- 建议后续结合代理池、账号池等手段进一步优化。

## 异步爬虫与缓冲池结构说明

### 异步爬虫（AsyncSpiderEngine）
- 基于 Python 的 asyncio 和 aiohttp 实现高并发异步爬取。
- 支持自适应拥塞控制，动态调整并发窗口和请求间隔，提升爬取效率并降低被限流风险。
- 通过批量调度和任务重试机制，提升大规模数据处理能力。
- 核心类：`AsyncSpiderEngine`，负责主流程调度、API请求、断点续传等。

### 缓冲池（BufferManager）
- 设计用于异步环境下高效批量写入文件，减少频繁IO操作带来的性能瓶颈。
- 支持数据缓冲、定时/批量写盘、自动关闭等功能。
- 与异步爬虫协作时，爬虫任务将结果异步推送到缓冲池，缓冲池自动管理写入节奏。
- 核心类：`BufferManager`，可配置缓冲区大小、写入策略等。

#### 协作示例
1. 爬虫任务通过 `await buffer_manager.put_data(data)` 异步推送结果。
2. BufferManager 在缓冲区满或定时触发时批量写入文件，极大降低磁盘IO压力。
3. 结束时调用 `await buffer_manager.stop()`，确保所有数据写盘。

**优势：**
- 异步爬虫+缓冲池结构可显著提升大规模数据抓取与写入的整体性能。
- 降低单次IO阻塞风险，适合高并发、海量数据场景。

## 许可证

本项目仅供学习和研究使用。

## 贡献

欢迎提交Issue和Pull Request来改进项目。 